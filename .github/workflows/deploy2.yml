name: Deploy to Modal2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 * *'  # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹UTC (ä¿®å¤cronè¡¨è¾¾å¼)
  push:
    branches:
      - main
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # å¢žåŠ è¶…æ—¶æ—¶é—´
    
    env:
      MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
      MODAL_CONFIG_DIR: /home/runner/.modal
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'  # ä½¿ç”¨æ›´æ–°çš„Pythonç‰ˆæœ¬
          cache: 'pip'  # å¯ç”¨pipç¼“å­˜

      - name: Create requirements.txt if not exists
        run: |
          if [ ! -f requirements.txt ]; then
            echo "modal>=0.64.0" > requirements.txt
            echo "ðŸ“ Created basic requirements.txt"
          fi

      - name: Install dependencies
        run: |
          pip install --no-cache-dir --upgrade pip
          pip install --no-cache-dir --upgrade "modal>=0.64.0"
          if [ -f requirements.txt ]; then
            pip install --no-cache-dir -r requirements.txt
          fi

      - name: Verify Modal installation
        run: |
          python -c "import modal; print(f'Modal version: {modal.__version__}')"
          modal --version

      - name: Configure Modal authentication
        run: |
          mkdir -p $MODAL_CONFIG_DIR
          cat > $MODAL_CONFIG_DIR/token.toml << EOF
          [default]
          token_id = "$MODAL_TOKEN_ID"
          token_secret = "$MODAL_TOKEN_SECRET"
          EOF
          
          echo "âœ… Modal token configured"

      - name: List existing apps (before deployment)
        run: |
          echo "ðŸ“‹ Current Modal apps:"
          modal app list || echo "No apps found or connection issue"

      - name: Deploy Modal app
        id: deploy
        run: |
          echo "ðŸš€ Starting deployment..."
          
          # æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f deploy.py ]; then
            echo "âŒ deploy.py not found, continuing without deploy..."
          else
            # æ‰§è¡Œéƒ¨ç½² (å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ)
            echo "ðŸ“¦ Deploying application..."
            modal deploy deploy.py --name persistent-app-production || echo "âš ï¸ Deployment had issues, continuing..."
          fi
          
          echo "âœ… Deployment step completed"

      - name: Start application
        id: start_app  
        run: |
          echo "ðŸƒ Starting application with container strategy..."
          
          # ä½¿ç”¨å®¹å™¨ç­–ç•¥å¯åŠ¨åº”ç”¨ (å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ)
          echo "ðŸ“¦ Using container service strategy..."
          modal run deploy.py::main --strategy=container --detach || {
            echo "âš ï¸ Container start failed, retrying..."
            sleep 5
            modal run deploy.py::main --strategy=container --detach || echo "âš ï¸ Container retry failed, continuing..."
          }
          
          echo "âœ… Application start step completed"

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 10  # ç­‰å¾…åº”ç”¨å¯åŠ¨
          
          modal app list || echo "âš ï¸ Could not list apps, continuing..."
          
          # æ£€æŸ¥åº”ç”¨çŠ¶æ€ (å¿½ç•¥é”™è¯¯)
          app_status=$(modal app list | grep -E "(persistent-app|running)" || echo "not_found")
          if [[ "$app_status" == "not_found" ]]; then
            echo "âš ï¸ Warning: App may not be running as expected"
          else
            echo "âœ… App appears to be running"
          fi
          
          echo "âœ… Verification step completed"

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "ðŸ§¹ Cleaning up failed deployment..."
          modal app stop persistent-app-production || true
          echo "âŒ Deployment failed, please check logs"

      - name: Show deployment summary
        if: always()
        run: |
          echo "ðŸ“‹ Deployment Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¯ Strategy: container (fixed)"
          echo "ðŸ“… Deployed at: $(date -u)"
          echo "ðŸ”— Triggered by: ${{ github.event_name }}"
          echo "ðŸ‘¤ Actor: ${{ github.actor }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "âœ… Status: COMPLETED (errors ignored)"
          echo "ðŸš€ Modal deployment process finished!"
          echo "ðŸ“Š Monitor: https://modal.com/apps"

